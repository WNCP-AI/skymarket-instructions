---
Title: SkyMarket Final Tech Stack
tags: 
  - WNCP_AI
  - ID-Ventures
  - drones
  - mobility
  - architecture
  - technical
  - production
created: 2025-08-15
Description: Production technical architecture for SkyMarket drone marketplace serving the greater Detroit metropolitan area, built on modern cloud-native stack.
MOC:
  - "[[WNCP_AI MOC]]"
  - "[[ID Ventures MOC]]"
---

# SkyMarket Final Tech Stack

## Executive Summary
SkyMarket is a production-ready drone service marketplace built on a **modern cloud-native architecture** serving the greater Detroit metropolitan area. The system leverages **Convex** as a unified backend platform, **Next.js 14** for the frontend, and carefully selected third-party services for payments, mapping, and communications. This architecture prioritizes reliability, scalability, and developer velocity while minimizing operational complexity.

## Architecture Overview

### System Architecture
```
┌─────────────────────────────────────────────────────────────┐
│                    SkyMarket Architecture                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Frontend Layer                                             │
│  ├── Next.js 14 App Router (React 18)                       │
│  ├── TypeScript 5                                           │
│  ├── Tailwind CSS + shadcn/ui                               │
│  └── Deployed on Vercel Edge Network                        │
│                                                             │
│  Backend Layer (Convex Platform)                           │
│  ├── Database (Document-based, ACID compliant)             │
│  ├── Functions (TypeScript, auto-scaling)                  │
│  ├── Auth (Built-in authentication)                        │
│  ├── File Storage (Integrated media handling)              │
│  └── Real-time Subscriptions (WebSocket)                   │
│                                                             │
│  Third-Party Services                                      │
│  ├── Stripe (Payments & Payouts)                          │
│  ├── Mapbox (Maps & Geocoding)                            │
│  ├── OpenAI (Content Generation)                           │
│  ├── Resend (Transactional Email)                         │
│  └── Twilio (SMS Notifications)                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### What Will Be Built
- **Unified Platform**: Single codebase serving consumers, providers, and administrators with role-based access.
- **Real-time Marketplace**: Live tracking, instant messaging, and dynamic pricing for drone services across Detroit Metro.
- **Compliance System**: Integrated FAA Part-107 verification, LAANC airspace checks, and weather gating for safe operations.
- **Financial Infrastructure**: Escrow payments, instant payouts, and transparent fee structures.

## Core Technology Stack

### Frontend Framework
```typescript
// package.json core dependencies
{
  "dependencies": {
    "next": "^14.2.0",
    "react": "^18.3.0",
    "react-dom": "^18.3.0",
    "typescript": "^5.4.0",
    "@types/react": "^18.3.0",
    "@types/node": "^20.0.0"
  }
}
```

#### Next.js 14 App Router
- **Server Components**: Default rendering for improved performance and SEO
- **API Routes**: Backend endpoints with edge runtime support
- **Image Optimization**: Automatic image processing and lazy loading
- **Static Generation**: Pre-rendered pages for marketing content
- **Dynamic Routes**: Flexible URL patterns for providers and services

#### TypeScript Configuration
```typescript
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["dom", "dom.iterable", "esnext"],
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "paths": {
      "@/*": ["./src/*"],
      "@/components/*": ["./src/components/*"],
      "@/lib/*": ["./src/lib/*"]
    }
  }
}
```

### UI & Styling
```typescript
// UI Dependencies
{
  "dependencies": {
    "tailwindcss": "^3.4.0",
    "@radix-ui/react-*": "latest",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.0",
    "lucide-react": "^0.300.0",
    "framer-motion": "^11.0.0"
  }
}
```

#### Component System
- **shadcn/ui**: Copy-paste components built on Radix UI primitives
- **Tailwind CSS**: Utility-first styling with custom design tokens
- **Framer Motion**: Smooth animations and transitions
- **Lucide Icons**: Consistent iconography across the platform

### Backend Platform (Convex)

#### Core Configuration
```typescript
// convex/schema.ts
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  users: defineTable({
    email: v.string(),
    role: v.union(v.literal("consumer"), v.literal("provider"), v.literal("admin")),
    profile: v.object({
      fullName: v.string(),
      phone: v.optional(v.string()),
      address: v.optional(v.string()),
      detroitZone: v.optional(v.string()) // Midtown, Downtown, etc.
    }),
    providerDetails: v.optional(v.object({
      type: v.union(v.literal("courier"), v.literal("drone")),
      certifications: v.array(v.string()),
      serviceAreas: v.array(v.string()), // Detroit neighborhoods
      rating: v.number(),
      completedJobs: v.number()
    }))
  }).index("by_email", ["email"]),

  listings: defineTable({
    providerId: v.id("users"),
    title: v.string(),
    description: v.string(),
    category: v.union(
      v.literal("food_delivery"),
      v.literal("courier"),
      v.literal("aerial_imaging"),
      v.literal("site_mapping")
    ),
    price: v.object({
      base: v.number(),
      perMile: v.optional(v.number()),
      perMinute: v.optional(v.number())
    }),
    serviceArea: v.object({
      center: v.object({ lat: v.number(), lng: v.number() }), // Detroit coords
      radiusMiles: v.number()
    }),
    availability: v.array(v.object({
      dayOfWeek: v.number(),
      startTime: v.string(),
      endTime: v.string()
    })),
    active: v.boolean()
  }).index("by_provider", ["providerId"])
    .index("by_category", ["category"])
    .searchIndex("search_listings", {
      searchField: "title",
      filterFields: ["category", "active"]
    }),

  bookings: defineTable({
    consumerId: v.id("users"),
    listingId: v.id("listings"),
    providerId: v.id("users"),
    status: v.union(
      v.literal("pending"),
      v.literal("accepted"),
      v.literal("in_progress"),
      v.literal("completed"),
      v.literal("cancelled")
    ),
    scheduledAt: v.number(),
    location: v.object({
      pickup: v.optional(v.object({
        address: v.string(),
        coords: v.object({ lat: v.number(), lng: v.number() })
      })),
      dropoff: v.object({
        address: v.string(),
        coords: v.object({ lat: v.number(), lng: v.number() })
      })
    }),
    payment: v.object({
      amount: v.number(),
      stripePaymentIntentId: v.string(),
      status: v.string()
    }),
    tracking: v.optional(v.object({
      currentLocation: v.object({ lat: v.number(), lng: v.number() }),
      eta: v.number(),
      lastUpdated: v.number()
    }))
  }).index("by_consumer", ["consumerId"])
    .index("by_provider", ["providerId"])
    .index("by_status", ["status"])
});
```

#### Convex Functions
```typescript
// convex/bookings.ts
import { mutation, query } from "./_generated/server";
import { v } from "convex/values";

export const createBooking = mutation({
  args: {
    listingId: v.id("listings"),
    location: v.object({
      pickup: v.optional(v.object({
        address: v.string(),
        coords: v.object({ lat: v.number(), lng: v.number() })
      })),
      dropoff: v.object({
        address: v.string(),
        coords: v.object({ lat: v.number(), lng: v.number() })
      })
    }),
    scheduledAt: v.number(),
    specialInstructions: v.optional(v.string())
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");

    // Validate service area for Detroit Metro
    const listing = await ctx.db.get(args.listingId);
    if (!isWithinServiceArea(args.location, listing.serviceArea)) {
      throw new Error("Location outside Detroit service area");
    }

    // Create Stripe payment intent
    const paymentIntent = await createStripePaymentIntent(
      calculatePrice(listing, args.location)
    );

    // Create booking
    return await ctx.db.insert("bookings", {
      consumerId: identity.userId,
      listingId: args.listingId,
      providerId: listing.providerId,
      status: "pending",
      scheduledAt: args.scheduledAt,
      location: args.location,
      payment: {
        amount: paymentIntent.amount,
        stripePaymentIntentId: paymentIntent.id,
        status: "pending"
      }
    });
  }
});

export const trackBooking = query({
  args: { bookingId: v.id("bookings") },
  handler: async (ctx, args) => {
    const booking = await ctx.db.get(args.bookingId);
    if (!booking) throw new Error("Booking not found");

    // Return real-time tracking data
    return {
      status: booking.status,
      tracking: booking.tracking,
      eta: booking.tracking?.eta,
      providerLocation: booking.tracking?.currentLocation
    };
  }
});
```

### Data Management

#### Database Features
- **ACID Transactions**: Guaranteed consistency for financial operations
- **Optimistic Concurrency Control**: Prevents race conditions in bookings
- **Real-time Subscriptions**: Live updates for tracking and messaging
- **Full-text Search**: Fast discovery of services and providers
- **Automatic Indexes**: Query optimization without manual tuning

#### File Storage
```typescript
// Media upload for drone imagery
export const uploadMedia = mutation({
  args: {
    bookingId: v.id("bookings"),
    storageId: v.string()
  },
  handler: async (ctx, { bookingId, storageId }) => {
    const url = await ctx.storage.getUrl(storageId);
    await ctx.db.patch(bookingId, {
      media: { url, uploadedAt: Date.now() }
    });
    return url;
  }
});
```

## Infrastructure & Services

### Deployment Platform (Vercel)
```json
// vercel.json
{
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "regions": ["cle1"], // Cleveland region for Detroit proximity
  "functions": {
    "app/api/webhooks/stripe/route.ts": {
      "maxDuration": 60
    }
  },
  "env": {
    "NEXT_PUBLIC_CONVEX_URL": "@convex_url",
    "CONVEX_DEPLOY_KEY": "@convex_deploy_key",
    "STRIPE_SECRET_KEY": "@stripe_secret_key",
    "MAPBOX_ACCESS_TOKEN": "@mapbox_access_token"
  }
}
```

### Payment Processing (Stripe)
```typescript
// lib/stripe.ts
import Stripe from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2023-10-16',
});

export async function createPaymentIntent(
  amount: number,
  metadata: {
    bookingId: string;
    consumerId: string;
    providerId: string;
  }
) {
  return stripe.paymentIntents.create({
    amount: Math.round(amount * 100), // Convert to cents
    currency: 'usd',
    metadata,
    automatic_payment_methods: {
      enabled: true,
    },
    application_fee_amount: Math.round(amount * 0.15 * 100), // 15% platform fee
  });
}

export async function createPayout(
  providerId: string,
  amount: number
) {
  return stripe.transfers.create({
    amount: Math.round(amount * 100),
    currency: 'usd',
    destination: providerId, // Stripe Connect account
    description: 'SkyMarket payout'
  });
}
```

### Mapping & Geospatial (Mapbox)
```typescript
// components/ServiceMap.tsx
import Map, { Marker, Source, Layer } from 'react-map-gl';
import 'mapbox-gl/dist/mapbox-gl.css';

const DETROIT_CENTER = {
  latitude: 42.3314,
  longitude: -83.0458,
  zoom: 11
};

export function ServiceMap({ providers, userLocation }) {
  return (
    <Map
      mapboxAccessToken={process.env.NEXT_PUBLIC_MAPBOX_TOKEN}
      initialViewState={DETROIT_CENTER}
      style={{ width: '100%', height: '100%' }}
      mapStyle="mapbox://styles/mapbox/light-v11"
    >
      {/* Service area polygons */}
      <Source
        id="service-areas"
        type="geojson"
        data={generateServiceAreaGeoJSON(providers)}
      >
        <Layer
          id="service-areas-fill"
          type="fill"
          paint={{
            'fill-color': '#BD1B04',
            'fill-opacity': 0.1
          }}
        />
      </Source>

      {/* Provider markers */}
      {providers.map(provider => (
        <Marker
          key={provider.id}
          latitude={provider.location.lat}
          longitude={provider.location.lng}
        >
          <ProviderPin type={provider.type} />
        </Marker>
      ))}
    </Map>
  );
}
```

### Communications

#### Email (Resend)
```typescript
// lib/email.ts
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

export async function sendBookingConfirmation(
  to: string,
  booking: BookingDetails
) {
  return resend.emails.send({
    from: 'SkyMarket <noreply@skymarket.com>',
    to,
    subject: 'Booking Confirmed - SkyMarket',
    react: BookingConfirmationEmail({ booking })
  });
}
```

#### SMS (Twilio)
```typescript
// lib/sms.ts
import twilio from 'twilio';

const client = twilio(
  process.env.TWILIO_ACCOUNT_SID,
  process.env.TWILIO_AUTH_TOKEN
);

export async function sendSMS(to: string, message: string) {
  return client.messages.create({
    body: message,
    from: process.env.TWILIO_PHONE_NUMBER,
    to
  });
}
```

### AI Integration (OpenAI)
```typescript
// lib/ai.ts
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export async function optimizeListing(
  title: string,
  description: string
): Promise<{ title: string; description: string; tags: string[] }> {
  const completion = await openai.chat.completions.create({
    model: "gpt-4-turbo-preview",
    messages: [
      {
        role: "system",
        content: "You are an expert at optimizing marketplace listings for drone services in Detroit."
      },
      {
        role: "user",
        content: `Optimize this listing:\nTitle: ${title}\nDescription: ${description}`
      }
    ],
    temperature: 0.7,
  });

  return JSON.parse(completion.choices[0].message.content);
}
```

## API Architecture

### RESTful Endpoints
```typescript
// app/api/listings/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { api } from '@/convex/_generated/api';
import { ConvexHttpClient } from 'convex/browser';

const client = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const category = searchParams.get('category');
  const lat = parseFloat(searchParams.get('lat') || '42.3314');
  const lng = parseFloat(searchParams.get('lng') || '-83.0458');

  const listings = await client.query(api.listings.search, {
    category,
    location: { lat, lng },
    radiusMiles: 10 // Detroit Metro area
  });

  return NextResponse.json({ listings });
}
```

### Real-time Subscriptions
```typescript
// hooks/useBookingTracking.ts
import { useQuery } from 'convex/react';
import { api } from '@/convex/_generated/api';

export function useBookingTracking(bookingId: string) {
  // Real-time subscription to booking updates
  const booking = useQuery(api.bookings.trackBooking, { bookingId });
  
  return {
    status: booking?.status,
    location: booking?.tracking?.currentLocation,
    eta: booking?.tracking?.eta,
    isLive: booking?.status === 'in_progress'
  };
}
```

### Webhook Handlers
```typescript
// app/api/webhooks/stripe/route.ts
export async function POST(request: Request) {
  const signature = request.headers.get('stripe-signature')!;
  const body = await request.text();

  let event: Stripe.Event;
  try {
    event = stripe.webhooks.constructEvent(
      body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    );
  } catch (err) {
    return new Response('Invalid signature', { status: 400 });
  }

  switch (event.type) {
    case 'payment_intent.succeeded':
      await handlePaymentSuccess(event.data.object);
      break;
    case 'payment_intent.payment_failed':
      await handlePaymentFailure(event.data.object);
      break;
    case 'transfer.paid':
      await handlePayoutComplete(event.data.object);
      break;
  }

  return new Response('OK', { status: 200 });
}
```

## Security & Compliance

### Authentication & Authorization
```typescript
// middleware.ts
import { authMiddleware } from '@convex-dev/auth/nextjs';

export default authMiddleware({
  publicRoutes: ["/", "/api/listings", "/about"],
  ignoredRoutes: ["/api/webhooks"],
});

// Role-based access control
export const requireRole = (allowedRoles: Role[]) => {
  return async (ctx: QueryCtx | MutationCtx) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");
    
    const user = await ctx.db.get(identity.userId);
    if (!allowedRoles.includes(user.role)) {
      throw new Error("Insufficient permissions");
    }
    
    return user;
  };
};
```

### Data Validation
```typescript
// lib/validation.ts
import { z } from 'zod';

export const bookingSchema = z.object({
  listingId: z.string(),
  scheduledAt: z.date().min(new Date()),
  location: z.object({
    pickup: z.object({
      address: z.string(),
      coords: z.object({
        lat: z.number().min(42.0).max(42.6), // Detroit bounds
        lng: z.number().min(-83.5).max(-82.8)
      })
    }).optional(),
    dropoff: z.object({
      address: z.string(),
      coords: z.object({
        lat: z.number().min(42.0).max(42.6),
        lng: z.number().min(-83.5).max(-82.8)
      })
    })
  }),
  specialInstructions: z.string().max(500).optional()
});
```

### Compliance Features
```typescript
// lib/compliance.ts
export async function checkAirspace(
  location: Coordinates,
  altitude: number
): Promise<AirspaceStatus> {
  // Check Detroit City Airport (DET) restrictions
  const detAirport = { lat: 42.4093, lng: -83.0098 };
  const distanceToDET = calculateDistance(location, detAirport);
  
  if (distanceToDET < 5 && altitude > 400) {
    return {
      approved: false,
      reason: "Within Detroit City Airport controlled airspace",
      requiresLAANC: true
    };
  }

  // Check for other Detroit area restrictions
  const restrictions = await fetchFAARestrictions(location);
  
  return {
    approved: !restrictions.length,
    restrictions,
    requiresLAANC: restrictions.some(r => r.type === 'controlled_airspace')
  };
}

export async function verifyPart107(certificateNumber: string): Promise<boolean> {
  // Verify FAA Part 107 certification
  const response = await fetch(`${FAA_API}/verify/${certificateNumber}`);
  const { valid, expiresAt } = await response.json();
  
  return valid && new Date(expiresAt) > new Date();
}
```

### Monitoring & Observability
```typescript
// lib/monitoring.ts
export function trackEvent(
  eventName: string,
  properties?: Record<string, any>
) {
  // Send to analytics
  if (typeof window !== 'undefined' && window.mixpanel) {
    window.mixpanel.track(eventName, {
      ...properties,
      timestamp: Date.now(),
      detroit_zone: getCurrentZone()
    });
  }

  // Log to Convex for internal analytics
  void logAnalyticsEvent({
    event: eventName,
    properties,
    userId: getCurrentUserId()
  });
}

// Performance monitoring
export function measureApiCall(endpoint: string) {
  const start = performance.now();
  
  return {
    end: () => {
      const duration = performance.now() - start;
      trackEvent('api_call', {
        endpoint,
        duration,
        success: true
      });
    }
  };
}
```

## Implementation Roadmap

### Phase 1: Core Platform (Weeks 1-4)
- Convex backend setup and schema definition
- Next.js application scaffolding
- Authentication flows with Convex Auth
- Basic listing and discovery features
- Provider onboarding and verification

### Phase 2: Marketplace Features (Weeks 5-8)
- Stripe payment integration with escrow
- Real-time tracking with Convex subscriptions
- Mapbox integration for Detroit area
- Booking and scheduling system
- Two-sided ratings and reviews

### Phase 3: Advanced Features (Weeks 9-12)
- AI-powered listing optimization
- LAANC integration for drone compliance
- Advanced search with filters
- Provider dashboard and analytics
- Admin console and moderation tools

### Phase 4: Launch Preparation (Weeks 13-16)
- Performance optimization and load testing
- Security audit and penetration testing
- Provider recruitment in Detroit Metro
- Marketing site and SEO optimization
- Soft launch with beta users

## Development Environment

### Local Setup
```bash
# Clone repository
git clone https://github.com/skymarket/platform.git
cd platform

# Install dependencies
npm install

# Environment variables
cp .env.example .env.local
# Add Convex, Stripe, Mapbox, and other API keys

# Run Convex dev server
npx convex dev

# Run Next.js dev server
npm run dev

# Access at http://localhost:3000
```

### Environment Variables
```bash
# .env.local
NEXT_PUBLIC_CONVEX_URL=https://your-project.convex.cloud
CONVEX_DEPLOY_KEY=your-deploy-key
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
NEXT_PUBLIC_MAPBOX_TOKEN=pk_...
OPENAI_API_KEY=sk-...
RESEND_API_KEY=re_...
TWILIO_ACCOUNT_SID=AC...
TWILIO_AUTH_TOKEN=...
TWILIO_PHONE_NUMBER=+1313...
```

### Testing Strategy
```typescript
// __tests__/booking.test.ts
import { expect, test } from '@jest/globals';
import { createBooking } from '@/lib/bookings';

test('booking within Detroit service area succeeds', async () => {
  const booking = await createBooking({
    listingId: 'test-listing',
    location: {
      dropoff: {
        address: '1 Campus Martius, Detroit, MI',
        coords: { lat: 42.3314, lng: -83.0458 }
      }
    },
    scheduledAt: Date.now() + 3600000
  });

  expect(booking.status).toBe('pending');
  expect(booking.location.dropoff.address).toContain('Detroit');
});

test('booking outside service area fails', async () => {
  await expect(createBooking({
    listingId: 'test-listing',
    location: {
      dropoff: {
        address: 'Chicago, IL',
        coords: { lat: 41.8781, lng: -87.6298 }
      }
    },
    scheduledAt: Date.now() + 3600000
  })).rejects.toThrow('outside Detroit service area');
});
```

## Vendor Summary

### Essential Services (6 vendors)
1. **Convex**: Unified backend platform ($0 to start, usage-based)
2. **Vercel**: Frontend hosting and edge functions (Free to start, $20/mo Pro)
3. **Stripe**: Payment processing (2.9% + $0.30 per transaction)
4. **Mapbox**: Maps and geocoding (50k free loads/month)
5. **OpenAI**: AI content generation ($0.03/1k tokens)
6. **Resend**: Transactional email (3k free emails/month)

### Optional Services
- **Twilio**: SMS notifications ($0.0075/SMS)
- **Mixpanel**: Product analytics (Free up to 100k events/month)
- **Sentry**: Error tracking (Free up to 5k events/month)

### Total Estimated Costs
- **Development Phase**: ~$100/month
- **Launch (1k users)**: ~$500/month
- **Scale (10k users)**: ~$2,500/month

---

## Conclusion

This production tech stack provides a robust foundation for SkyMarket's drone service marketplace in Detroit. By leveraging Convex's unified backend platform, we eliminate complexity while maintaining the flexibility to scale. The architecture supports all requirements from the PRD while optimizing for developer velocity and operational efficiency.

The modular design allows for incremental feature development and easy testing, while the modern toolchain ensures excellent developer experience. With built-in compliance features for drone operations and a focus on the Detroit market, this stack positions SkyMarket for successful launch and growth.

---

*This document serves as the technical blueprint for SkyMarket's production implementation.*